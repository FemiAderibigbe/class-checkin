<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Portal</title>
    <style>
        :root { --primary: #2563eb; --bg: #f3f4f6; --card: #ffffff; }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background: var(--card); padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        h1 { color: var(--primary); margin-top: 0; }
        
        .form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #374151; font-size: 0.9rem; }
        input { width: 93%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; outline: none; }
        input:focus { border-color: var(--primary); }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; background-color: var(--primary); color: white; font-size: 1rem; margin-top: 10px; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        
        #status { margin-top: 15px; font-size: 0.9rem; min-height: 20px; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
    </style>
</head>
<body>

<div class="container">
    <h1>Class Check-In</h1>

    <div class="form-group">
        <label>Lecture Code</label>
        <input type="text" id="lectureInput" placeholder="e.g. Pathology 101" required>
    </div>

    <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="nameInput" placeholder="Idan Idolozin" required>
    </div>

    <div class="form-group">
        <label> S3 Log Code</label>
        <input type="text" id="codeInput" placeholder="Enter ID" required>
    </div>

    <button id="submitBtn" onclick="sendData()">Submit Attendance</button>
    <div id="status"></div>
</div>

<script>
    const lectureField = document.getElementById('lectureInput');
    const nameField = document.getElementById('nameInput');
    const codeField = document.getElementById('codeInput');
    const btn = document.getElementById('submitBtn');
    const statusDiv = document.getElementById('status');

    // !!! PASTE YOUR GOOGLE SCRIPT URL HERE !!!
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz9E4tov3UVqrUUrCm4YTM0xoj-PaRF923-eU0gfb0DeWQN8jKj_HrdWY4PGmQvx1Ld-g/exec"; 

    function sendData() {
        const lecture = lectureField.value.trim();
        const name = nameField.value.trim();
        const code = codeField.value.trim();

        if (!lecture || !name || !code) {
            statusDiv.innerHTML = "<span class='error'>Please fill in all fields.</span>";
            return;
        }

        btn.disabled = true;
        btn.innerText = "Checking...";
        statusDiv.innerText = "";

        // 1. Get IP (Optional)
        fetch('https://api.ipify.org?format=json')
        .then(response => response.json())
        .then(data => {
            submitToGoogle(lecture, name, code, data.ip, navigator.userAgent);
        })
        .catch(() => {
            submitToGoogle(lecture, name, code, "Unknown", navigator.userAgent);
        });
    }

    function submitToGoogle(lecture, name, code, ip, device) {
        // 2. PREPARE DATA AS FORM PARAMS (New Method)
        const formData = new URLSearchParams();
        formData.append('lecture', lecture);
        formData.append('name', name);
        formData.append('code', code);
        formData.append('ip', ip);
        formData.append('device', device);

        // 3. SEND REQUEST
        fetch(SCRIPT_URL, {
            method: 'POST',
            body: formData 
            // Note: We removed 'no-cors'. This lets us read the answer!
        })
        .then(response => response.json())
        .then(data => {
            if (data.result === "success") {
                statusDiv.innerHTML = "<span class='success'>✅ Success! " + name + " recorded.</span>";
                nameField.value = '';
                codeField.value = '';
                nameField.focus();
            } else if (data.result === "duplicate") {
                statusDiv.innerHTML = "<span style='color:orange'>⚠️ " + name + " has already submitted!</span>";
            } else {
                statusDiv.innerHTML = "<span class='error'>Error. Please try again.</span>";
            }
            
            btn.disabled = false;
            btn.innerText = "Submit Attendance";
        })
        .catch(err => {
            console.error(err);
            statusDiv.innerHTML = "<span class='error'>Connection Error.</span>";
            btn.disabled = false;
            btn.innerText = "Submit Attendance";
        });
    }

    // Allow Enter key
    codeField.addEventListener("keypress", function(event) {
        if (event.key === "Enter") sendData();
    });
</script>

</body>
</html>


